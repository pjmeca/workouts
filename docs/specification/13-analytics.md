# Analytics and training stats

## Goal
Store workout history for each user without losing data when plans/days/exercises are deleted.

## Data to store
- Full run duration (seconds).
- Per-set elapsed time (seconds) for each exercise.
- Rest time between sets (seconds).

## Data model
See `03-data-model.md` for:
- `TrainingRun`
- `TrainingRunSet`

Key rules:
- `TrainingRun.Id` is a GUID generated by the server.
- `TrainingRunSet` uses a composite key `(TrainingRunId, ExerciseId, SetIndex)`.
- `SetIndex` is 0-based per exercise within the run.

## Client-side capture
- While the run is active, store stats in session storage:
  - Per-set elapsed seconds.
  - Per-set rest seconds (after the set, if any).
  - Total run seconds.
- Do not send stats continuously; send one JSON payload when the user completes the run.

## Payload format (proposed)
```json
{
  "planId": "GUID",
  "dayId": 1,
  "startedAt": "2026-02-03T21:15:00Z",
  "completedAt": "2026-02-03T21:35:20Z",
  "totalSeconds": 1220,
  "sets": [
    {
      "exerciseId": 1,
      "setIndex": 0,
      "durationSeconds": 35,
      "restSecondsAfter": 60
    },
    {
      "exerciseId": 1,
      "setIndex": 1,
      "durationSeconds": 32,
      "restSecondsAfter": 60
    }
  ]
}
```

## Backend flow
- Add a service (e.g., `TrainingRunService`) responsible for:
  - Validating that the plan/day/exercises belong to the current user.
  - Creating a new `TrainingRun` GUID.
  - Inserting `TrainingRun` and `TrainingRunSet` rows in one transaction.
- The Play completion handler should:
  - POST the payload to a backend handler.
  - Persist stats through the service.
  - Update the next-day pointer.

## Soft delete interaction
- Analytics data is never deleted.
- Soft-deleting plans/days/exercises keeps analytics rows intact.
- Images are still deleted physically when exercises are deleted.
